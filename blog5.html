<!DOCTYPE html>
<html lang="en">
<head>
          <title>sumer - Huey</title>
        <meta charset="utf-8" />
        <link href="https://amanchl.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="sumer Full Atom Feed" />
        <link href="https://amanchl.github.io/blog/feeds/misc.atom.xml" type="application/atom+xml" rel="alternate" title="sumer Categories Atom Feed" />





</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">sumer <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li class="active"><a href="./category/misc.html">misc</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="./blog5.html" rel="bookmark"
         title="Permalink to Huey">Huey</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2020-02-02T07:40:00-05:00">
      Sun 02 February 2020
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="./author/aman-chahal.html">Aman Chahal</a>
    </address>
    <div class="category">
        Category: <a href="./category/misc.html">misc</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Today, I'll be covering a lightweight task queue package for Python called Huey. It's a neat little package for task execution at a given time or a specified delay. It's also quite handy for scheduling recurring tasks, automatically retrying failed tasks, as well as a host of other nifty features.</p>
<p>For this particular post, I'll be grabbing Apple stock prices in real time, and using Huey to update my data in real time. For this purpose, I will be using the Yahoo Finance API.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
</pre></div>


<p>I'll now import the requisite packages and instantiate Huey. For this example, I will be using the Immediate Mode instead of a local Redis server or SQLite, but I will be updating this post later on and cover those features as well. In immediate mode, Huey will execute task functions immediately rather than queueing them, but it will preserve the behaviors  of a dedicated consumer process (not covered today).</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">huey</span> <span class="kn">import</span> <span class="n">RedisHuey</span><span class="p">,</span> <span class="n">crontab</span>
<span class="kn">from</span> <span class="nn">huey</span> <span class="kn">import</span> <span class="n">crontab</span>

<span class="n">huey</span> <span class="o">=</span> <span class="n">RedisHuey</span><span class="p">(</span><span class="s1">&#39;my-app&#39;</span><span class="p">,</span> <span class="n">immediate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>


<p>Here, I will grab some Apple stocks data for the last 7 days on a refresh interval of 1 minute, and put it into a Pandas DataFrame, which I will iterate over with new data using Huey.</p>
<div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span> <span class="s2">&quot;AAPL&quot;</span><span class="p">,</span>
<span class="n">period</span><span class="o">=</span><span class="s2">&quot;7d&quot;</span><span class="p">,</span>
<span class="n">interval</span><span class="o">=</span><span class="s2">&quot;1m&quot;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">[*********************100%***********************]  1 of 1 completed</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-01-31 15:55:00-05:00</th>
      <td>309.940002</td>
      <td>310.049988</td>
      <td>309.640015</td>
      <td>309.649994</td>
      <td>309.649994</td>
      <td>240384</td>
    </tr>
    <tr>
      <th>2020-01-31 15:56:00-05:00</th>
      <td>309.640015</td>
      <td>309.670013</td>
      <td>309.170013</td>
      <td>309.429993</td>
      <td>309.429993</td>
      <td>327785</td>
    </tr>
    <tr>
      <th>2020-01-31 15:57:00-05:00</th>
      <td>309.429993</td>
      <td>309.799988</td>
      <td>309.369995</td>
      <td>309.779999</td>
      <td>309.779999</td>
      <td>248953</td>
    </tr>
    <tr>
      <th>2020-01-31 15:58:00-05:00</th>
      <td>309.779999</td>
      <td>309.809998</td>
      <td>309.559998</td>
      <td>309.649994</td>
      <td>309.649994</td>
      <td>314132</td>
    </tr>
    <tr>
      <th>2020-01-31 15:59:00-05:00</th>
      <td>309.640015</td>
      <td>309.690002</td>
      <td>309.130005</td>
      <td>309.390015</td>
      <td>309.390015</td>
      <td>578890</td>
    </tr>
  </tbody>
</table>
</div>

<p>Below is a function that grabs Apple stock data from Yahoo Finance and concatenates it on top of the existing data.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stocks</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="n">newdata</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="o">=</span> <span class="s2">&quot;AAPL&quot;</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="s2">&quot;1m&quot;</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;1m&quot;</span><span class="p">)</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span><span class="n">newdata</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final</span>
</pre></div>


<p>This Huey periodic task function carries out the function above each minute between 9AM and 4PM Monday through Friday. The time intervals can be changed depending on the use case.</p>
<div class="highlight"><pre><span></span><span class="nd">@huey</span><span class="o">.</span><span class="n">periodic_task</span><span class="p">(</span><span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s1">&#39;*/1&#39;</span><span class="p">,</span><span class="n">hour</span><span class="o">=</span><span class="s1">&#39;9-16&#39;</span><span class="p">,</span><span class="n">day_of_week</span><span class="o">=</span><span class="s1">&#39;1-5&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">update_stocks</span><span class="p">():</span>
    <span class="n">stocks</span><span class="p">()</span>
</pre></div>


<p>The task has been executed below. Once a local server has been integrated into this process, the task will recur each minute and update our stock data in real time.</p>
<div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">update_stocks</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">[*********************100%***********************]  1 of 1 completed</span>
</pre></div>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>